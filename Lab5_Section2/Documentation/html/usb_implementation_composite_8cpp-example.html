<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lab5_Section2: usb_implementation_composite.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lab5_Section2
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('usb_implementation_composite_8cpp-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">usb_implementation_composite.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file     usb_implementation_composite.cpp</span></div><div class="line"><span class="comment"> * @brief    USB Composite device implementation</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This module provides an implementation of a USB Composite interface</span></div><div class="line"><span class="comment"> * including the following end points:</span></div><div class="line"><span class="comment"> *  - EP0 Standard control</span></div><div class="line"><span class="comment"> *  - EP1 Bulk OUT</span></div><div class="line"><span class="comment"> *  - EP2 Bulk IN</span></div><div class="line"><span class="comment"> *  - EP3 Interrupt CDC notification</span></div><div class="line"><span class="comment"> *  - EP4 CDC data OUT</span></div><div class="line"><span class="comment"> *  - EP5 CDC data IN</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @version  V4.12.1.170</span></div><div class="line"><span class="comment"> * @date     2 April 2017</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  This file provides the implementation specific code for the USB interface.</span></div><div class="line"><span class="comment"> *  It will need to be modified to suit an application.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="usb_8h.html">usb.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;usb_implementation_composite.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a> {</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Interface numbers for USB descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">enum</span> InterfaceNumbers {<span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for BDM channel */</span></div><div class="line">   BULK_INTF_ID,</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for CDC Control channel */</span></div><div class="line">   CDC_COMM_INTF_ID,</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /** Interface number for CDC Data channel */</span></div><div class="line">   CDC_DATA_INTF_ID,</div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * TODO Add additional Interface numbers here</span></div><div class="line"><span class="comment">    */</span><span class="comment"></span></div><div class="line"><span class="comment">   /** Total number of interfaces */</span></div><div class="line">   NUMBER_OF_INTERFACES,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * String descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_language[]        = {4, <a name="a0"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a4313207b96335e124ddd0664a0794cad">DT_STRING</a>, 0x09, 0x0C};  <span class="comment">//!&lt; Language IDs</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_manufacturer[]    = MANUFACTURER;                <span class="comment">//!&lt; Manufacturer</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_product[]         = PRODUCT_DESCRIPTION;         <span class="comment">//!&lt; Product Description</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_serial[]          = SERIAL_NO;                   <span class="comment">//!&lt; Serial Number</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_config[]          = <span class="stringliteral">&quot;Default configuration&quot;</span>;     <span class="comment">//!&lt; Configuration name</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_bulk_interface[]  = <span class="stringliteral">&quot;Bulk Interface&quot;</span>;            <span class="comment">//!&lt; Bulk Interface</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_interface[]   = <span class="stringliteral">&quot;CDC Interface&quot;</span>;             <span class="comment">//!&lt; Interface Association #2</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_control[]     = <span class="stringliteral">&quot;CDC Control Interface&quot;</span>;     <span class="comment">//!&lt; CDC Control Interface</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> <span class="keyword">const</span> uint8_t s_cdc_data[]        = <span class="stringliteral">&quot;CDC Data Interface&quot;</span>;        <span class="comment">//!&lt; CDC Data Interface</span></div><div class="line"><span class="comment"></span><span class="comment">/*</span></div><div class="line"><span class="comment"> * Add additional String descriptors here</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * String descriptor table</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> uint8_t *<span class="keyword">const</span> Usb0::stringDescriptors[] = {</div><div class="line">      s_language,</div><div class="line">      s_manufacturer,</div><div class="line">      s_product,</div><div class="line">      s_serial,</div><div class="line">      s_config,</div><div class="line"></div><div class="line">      s_bulk_interface,</div><div class="line"></div><div class="line">      s_cdc_interface,</div><div class="line">      s_cdc_control,</div><div class="line">      s_cdc_data</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * Add additional String descriptors here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Device Descriptor</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> <a name="_a1"></a><a class="code" href="struct_device_descriptor.html">DeviceDescriptor</a> Usb0::deviceDescriptor = {</div><div class="line">      <span class="comment">/* bLength             */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_device_descriptor.html">DeviceDescriptor</a>),</div><div class="line">      <span class="comment">/* bDescriptorType     */</span> <a name="a2"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3aaa26590719e45fb45e7a547d5832438e">DT_DEVICE</a>,</div><div class="line">      <span class="comment">/* bcdUSB              */</span> <a name="a3"></a><a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(0x0200),           <span class="comment">// USB specification release No. [BCD = 2.00]</span></div><div class="line">      <span class="comment">/* bDeviceClass        */</span> 0xEF,                           <span class="comment">// Device Class code [Miscellaneous Device Class]</span></div><div class="line">      <span class="comment">/* bDeviceSubClass     */</span> 0x02,                           <span class="comment">// Sub Class code    [Common Class]</span></div><div class="line">      <span class="comment">/* bDeviceProtocol     */</span> 0x01,                           <span class="comment">// Protocol          [Interface Association Descriptor]</span></div><div class="line">      <span class="comment">/* bMaxPacketSize0     */</span> CONTROL_EP_MAXSIZE,             <span class="comment">// EndPt 0 max packet size</span></div><div class="line">      <span class="comment">/* idVendor            */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(VENDOR_ID),        <span class="comment">// Vendor ID</span></div><div class="line">      <span class="comment">/* idProduct           */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(PRODUCT_ID),       <span class="comment">// Product ID</span></div><div class="line">      <span class="comment">/* bcdDevice           */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(VERSION_ID),       <span class="comment">// Device Release</span></div><div class="line">      <span class="comment">/* iManufacturer       */</span> s_manufacturer_index,           <span class="comment">// String index of Manufacturer name</span></div><div class="line">      <span class="comment">/* iProduct            */</span> s_product_index,                <span class="comment">// String index of product description</span></div><div class="line">      <span class="comment">/* iSerialNumber       */</span> s_serial_index,                 <span class="comment">// String index of serial number</span></div><div class="line">      <span class="comment">/* bNumConfigurations  */</span> NUMBER_OF_CONFIGURATIONS        <span class="comment">// Number of configurations</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * All other descriptors</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> Usb0::Descriptors Usb0::otherDescriptors = {</div><div class="line">      { <span class="comment">// configDescriptor</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a4"></a><a class="code" href="struct_configuration_descriptor.html">ConfigurationDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a5"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a156f255f1193aefbee57b8abdeaedbe4">DT_CONFIGURATION</a>,</div><div class="line">            <span class="comment">/* wTotalLength            */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(<span class="keyword">sizeof</span>(otherDescriptors)),</div><div class="line">            <span class="comment">/* bNumInterfaces          */</span> NUMBER_OF_INTERFACES,</div><div class="line">            <span class="comment">/* bConfigurationValue     */</span> CONFIGURATION_NUM,</div><div class="line">            <span class="comment">/* iConfiguration          */</span> s_config_index,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> 0x80,     <span class="comment">//  = Bus powered, no wake-up</span></div><div class="line">            <span class="comment">/* bMaxPower               */</span> <a name="a6"></a><a class="code" href="group___u_s_b___group.html#ga403c0219269482c444d915b70302d0be">USBMilliamps</a>(500)</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * Bulk interface, 2 end-points</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// bulk_interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a7"></a><a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a8"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3af9666388d13da1162d6210f33d26ee7a">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> BULK_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 2,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0xFF,                         <span class="comment">// (Vendor specific)</span></div><div class="line">            <span class="comment">/* iInterface desc         */</span> s_bulk_interface_index,</div><div class="line">      },</div><div class="line">      { <span class="comment">// bulk_out_endpoint - OUT, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a9"></a><a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a10"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a39c1c984ee8f868124f0171983f2bd37">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a name="a11"></a><a class="code" href="group___u_s_b___group.html#gga3babbf89cae9b856a12864a41506efbda09451b411e1b9e3da67123d0bec0b421">EP_OUT</a>|BULK_OUT_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a name="a12"></a><a class="code" href="group___u_s_b___group.html#ga56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(BULK_OUT_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a name="a13"></a><a class="code" href="group___u_s_b___group.html#ga683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// bulk_in_endpoint - IN, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a39c1c984ee8f868124f0171983f2bd37">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a name="a14"></a><a class="code" href="group___u_s_b___group.html#gga3babbf89cae9b856a12864a41506efbda4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|BULK_IN_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="group___u_s_b___group.html#ga56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(BULK_IN_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="group___u_s_b___group.html#ga683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// interfaceAssociationDescriptorCDC</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a name="_a15"></a><a class="code" href="struct_interface_association_descriptor.html">InterfaceAssociationDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a16"></a><a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3ac75207ae6796e65880acdc0d7b9ad8a3">DT_INTERFACEASSOCIATION</a>,</div><div class="line">            <span class="comment">/* bFirstInterface         */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bInterfaceCount         */</span> 2,</div><div class="line">            <span class="comment">/* bFunctionClass          */</span> 0x02,                                   <span class="comment">//  CDC Control</span></div><div class="line">            <span class="comment">/* bFunctionSubClass       */</span> 0x02,                                   <span class="comment">//  Abstract Control Model</span></div><div class="line">            <span class="comment">/* bFunctionProtocol       */</span> 0x01,                                   <span class="comment">//  AT CommandL V.250</span></div><div class="line">            <span class="comment">/* iFunction = &quot;&quot;          */</span> s_cdc_interface_index,</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * CDC Control/Communication Interface, 1 end-point</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// cdc_CCI_Interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3af9666388d13da1162d6210f33d26ee7a">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 1,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0x02,      <span class="comment">//  CDC Communication</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0x02,      <span class="comment">//  Abstract Control Model</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0x01,      <span class="comment">//  V.25ter, AT Command V.250</span></div><div class="line">            <span class="comment">/* iInterface description  */</span> s_cdc_control_interface_index</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_Header</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a17"></a><a class="code" href="struct_c_d_c_header_functional_descriptor.html">CDCHeaderFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a name="a18"></a><a class="code" href="group___u_s_b___group.html#ga104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a19"></a><a class="code" href="group___u_s_b___group.html#ga42a839b8d9e39bf51aef5b36479b1ed2">DST_HEADER</a>,</div><div class="line">            <span class="comment">/* bcdCDC                  */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(0x0110),</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_CallManagement</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a20"></a><a class="code" href="struct_c_d_c_call_management_functional_descriptor.html">CDCCallManagementFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ga104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a21"></a><a class="code" href="group___u_s_b___group.html#ga56e20b25adaace43513bdc85f0a3e709">DST_CALL_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmCapabilities          */</span> 1,</div><div class="line">            <span class="comment">/* bDataInterface          */</span> CDC_DATA_INTF_ID,</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_ACM</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a22"></a><a class="code" href="struct_c_d_c_abstract_control_management_descriptor.html">CDCAbstractControlManagementDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ga104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a23"></a><a class="code" href="group___u_s_b___group.html#gadc08ecc6601ffea46eb02eb2ddda6b50">DST_ABSTRACT_CONTROL_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmCapabilities          */</span> 0x06,</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_Functional_Union</span></div><div class="line">            <span class="comment">/* bFunctionalLength       */</span> <span class="keyword">sizeof</span>(<a name="_a24"></a><a class="code" href="struct_c_d_c_union_functional_descriptor.html">CDCUnionFunctionalDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ga104f7f440633d5d270fba57dfa0666d0">CS_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bDescriptorSubtype      */</span> <a name="a25"></a><a class="code" href="group___u_s_b___group.html#ga37b0be8334ea3077604b08d6b0dfcbc6">DST_UNION_MANAGEMENT</a>,</div><div class="line">            <span class="comment">/* bmControlInterface      */</span> CDC_COMM_INTF_ID,</div><div class="line">            <span class="comment">/* bSubordinateInterface0  */</span> {CDC_DATA_INTF_ID},</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_notification_Endpoint - IN,interrupt</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a39c1c984ee8f868124f0171983f2bd37">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="group___u_s_b___group.html#gga3babbf89cae9b856a12864a41506efbda4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|CDC_NOTIFICATION_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a name="a26"></a><a class="code" href="group___u_s_b___group.html#gaaf8e3e725be9d83152af5c62c8ca003c">ATTR_INTERRUPT</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_NOTIFICATION_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="group___u_s_b___group.html#ga683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(255)</div><div class="line">      },<span class="comment"></span></div><div class="line"><span class="comment">      /**</span></div><div class="line"><span class="comment">       * CDC Data Interface, 2 end-points</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      { <span class="comment">// cdc_DCI_Interface</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3af9666388d13da1162d6210f33d26ee7a">DT_INTERFACE</a>,</div><div class="line">            <span class="comment">/* bInterfaceNumber        */</span> CDC_DATA_INTF_ID,</div><div class="line">            <span class="comment">/* bAlternateSetting       */</span> 0,</div><div class="line">            <span class="comment">/* bNumEndpoints           */</span> 2,</div><div class="line">            <span class="comment">/* bInterfaceClass         */</span> 0x0A,                         <span class="comment">//  CDC DATA</span></div><div class="line">            <span class="comment">/* bInterfaceSubClass      */</span> 0x00,                         <span class="comment">//  -</span></div><div class="line">            <span class="comment">/* bInterfaceProtocol      */</span> 0x00,                         <span class="comment">//  -</span></div><div class="line">            <span class="comment">/* iInterface description  */</span> s_cdc_data_Interface_index</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_dataOut_Endpoint - OUT, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a39c1c984ee8f868124f0171983f2bd37">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="group___u_s_b___group.html#gga3babbf89cae9b856a12864a41506efbda09451b411e1b9e3da67123d0bec0b421">EP_OUT</a>|CDC_DATA_OUT_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="group___u_s_b___group.html#ga56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_DATA_OUT_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="group___u_s_b___group.html#ga683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      { <span class="comment">// cdc_dataIn_Endpoint - IN, Bulk</span></div><div class="line">            <span class="comment">/* bLength                 */</span> <span class="keyword">sizeof</span>(<a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>),</div><div class="line">            <span class="comment">/* bDescriptorType         */</span> <a class="code" href="group___u_s_b___group.html#ggaaf86964e07079f57562728ea953b61c3a39c1c984ee8f868124f0171983f2bd37">DT_ENDPOINT</a>,</div><div class="line">            <span class="comment">/* bEndpointAddress        */</span> <a class="code" href="group___u_s_b___group.html#gga3babbf89cae9b856a12864a41506efbda4baa33e30d47dfc6f9406f98fc906456">EP_IN</a>|CDC_DATA_IN_ENDPOINT,</div><div class="line">            <span class="comment">/* bmAttributes            */</span> <a class="code" href="group___u_s_b___group.html#ga56161d6bedecf83b37aadfc4dec35432">ATTR_BULK</a>,</div><div class="line">            <span class="comment">/* wMaxPacketSize          */</span> <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(CDC_DATA_IN_EP_MAXSIZE),</div><div class="line">            <span class="comment">/* bInterval               */</span> <a class="code" href="group___u_s_b___group.html#ga683349ac97e51523fc952a049bf11a25">USBMilliseconds</a>(1)</div><div class="line">      },</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional Descriptors here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">};</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Out end-point for BULK data out */</span></div><div class="line">OutEndpoint &lt;Usb0Info, Usb0::BULK_OUT_ENDPOINT,         BULK_OUT_EP_MAXSIZE&gt;          Usb0::epBulkOut(<a name="a27"></a><a class="code" href="group___u_s_b___group.html#gga7af8062eac6cbc3490ad239d9f8f7944a7e1a6971f896ea993eb4ddecf9309c8c">EndPointType_Bulk</a>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for BULK data in */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::BULK_IN_ENDPOINT,          BULK_IN_EP_MAXSIZE&gt;           Usb0::epBulkIn(<a class="code" href="group___u_s_b___group.html#gga7af8062eac6cbc3490ad239d9f8f7944a7e1a6971f896ea993eb4ddecf9309c8c">EndPointType_Bulk</a>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for CDC notifications */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::CDC_NOTIFICATION_ENDPOINT, CDC_NOTIFICATION_EP_MAXSIZE&gt;  Usb0::epCdcNotification(<a class="code" href="group___u_s_b___group.html#gga7af8062eac6cbc3490ad239d9f8f7944a7e1a6971f896ea993eb4ddecf9309c8c">EndPointType_Bulk</a>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Out end-point for CDC data out */</span></div><div class="line">OutEndpoint &lt;Usb0Info, Usb0::CDC_DATA_OUT_ENDPOINT,     CDC_DATA_OUT_EP_MAXSIZE&gt;      Usb0::epCdcDataOut(<a name="a28"></a><a class="code" href="group___u_s_b___group.html#gga7af8062eac6cbc3490ad239d9f8f7944a7f28e2d0975b762a68b1cf3509d250df">EndPointType_Interrupt</a>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** In end-point for CDC data in */</span></div><div class="line">InEndpoint  &lt;Usb0Info, Usb0::CDC_DATA_IN_ENDPOINT,      CDC_DATA_IN_EP_MAXSIZE&gt;       Usb0::epCdcDataIn(<a class="code" href="group___u_s_b___group.html#gga7af8062eac6cbc3490ad239d9f8f7944a7f28e2d0975b762a68b1cf3509d250df">EndPointType_Interrupt</a>);</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * TODO Add additional end-points here</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handler for Start of Frame Token interrupt (~1ms interval)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param frameNumber Frame number from SOF token</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return  E_NO_ERROR on success</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a name="a29"></a><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26">ErrorCode</a> Usb0::sofCallback(uint16_t frameNumber) {</div><div class="line">   <span class="comment">// Activity LED</span></div><div class="line">   <span class="comment">// Off                     - no USB activity, not connected</span></div><div class="line">   <span class="comment">// On                      - no USB activity, connected</span></div><div class="line">   <span class="comment">// Off, flash briefly on   - USB activity, not connected</span></div><div class="line">   <span class="comment">// On,  flash briefly off  - USB activity, connected</span></div><div class="line">   <span class="keywordflow">if</span> ((frameNumber&amp;0xFF)==0) {</div><div class="line">      <span class="comment">// Every ~256 ms</span></div><div class="line">      <span class="keywordflow">switch</span> ((frameNumber&gt;&gt;8)&amp;0x3) {</div><div class="line">         <span class="keywordflow">case</span> 0:</div><div class="line">            <span class="comment">// LED on if configured, off if not</span></div><div class="line"><span class="comment">//            UsbLed::write(fConnectionState == USBconfigured);</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         <span class="keywordflow">case</span> 1:</div><div class="line">         <span class="keywordflow">case</span> 2:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         <span class="keywordflow">case</span> 3:</div><div class="line">         default :</div><div class="line">            <span class="keywordflow">if</span> (fActivityFlag) {</div><div class="line">               <span class="comment">// Activity LED flashes</span></div><div class="line"><span class="comment">//               UsbLed::toggle();</span></div><div class="line">               setActive(<span class="keyword">false</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="comment">// Check CDC status</span></div><div class="line">   epCdcSendNotification();</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> <a name="a30"></a><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26a4ba45ce064022eb4eb90e52c3d48a83a">E_NO_ERROR</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26">ErrorCode</a> userCallbackFunction(<span class="keyword">const</span> Usb0::UserEvent event) {</div><div class="line">   <span class="keywordflow">switch</span>(event) {</div><div class="line">      <span class="keywordflow">case</span> Usb0::UserEvent_Suspend:</div><div class="line">      <span class="keywordflow">case</span> Usb0::UserEvent_Reset:</div><div class="line"><span class="comment">//         UsbLed::off();</span></div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Usb0::UserEvent_Resume:</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26a4ba45ce064022eb4eb90e52c3d48a83a">E_NO_ERROR</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configure epCdcNotification for an IN status transaction [Tx, device -&gt; host, DATA0/1]\n</span></div><div class="line"><span class="comment"> * A packet is only sent if there has been a change in status</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::epCdcSendNotification() {</div><div class="line"><span class="comment">//   if (fConnectionState != USBconfigured) {</span></div><div class="line"><span class="comment">//      // Only send notifications if configured.</span></div><div class="line"><span class="comment">//      return;</span></div><div class="line"><span class="comment">//   }</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <a name="_a31"></a><a class="code" href="struct_c_d_c_notification.html">CDCNotification</a> cdcNotification = {</div><div class="line">         <a name="a32"></a><a class="code" href="group___u_s_b___group.html#ga219a2d18e82dc6245cc8b1aa12c6377f">CDC_NOTIFICATION</a>, <a name="a33"></a><a class="code" href="group___u_s_b___group.html#ga8e278dbd137d5d873d24e1647be9d4e6">SERIAL_STATE</a>, 0, <a name="a34"></a><a class="code" href="group___u_s_b___group.html#ga9eddb8dd2bb93652af10997713015eab">RT_INTERFACE</a>, <a class="code" href="utilities_8h.html#a6239c76fc39b23c0e15f60c978657adf">nativeToLe16</a>(2)</div><div class="line">   };</div><div class="line">   <span class="keyword">static</span> uint8_t lastStatus = -1;</div><div class="line">   uint8_t status = cdcInterface::getSerialState().bits;</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (status == lastStatus) {</div><div class="line">      <span class="comment">// No change</span></div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">if</span> (epCdcNotification.getState() != <a name="a35"></a><a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <span class="comment">// Busy with previous</span></div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line">   static_assert(epCdcNotification.BUFFER_SIZE&gt;=<span class="keyword">sizeof</span>(<a class="code" href="struct_c_d_c_notification.html">CDCNotification</a>), <span class="stringliteral">&quot;Buffer size insufficient&quot;</span>);</div><div class="line"></div><div class="line">   lastStatus = status;</div><div class="line"></div><div class="line">   <span class="comment">// Copy the data to Tx buffer</span></div><div class="line">   <a name="a36"></a><a class="code" href="class_u_s_b_d_m_1_1_endpoint.html#a298ef32b4fc2f62d5ad0d911a507a944">Endpoint::safeCopy</a>(epCdcNotification.getBuffer(), &amp;cdcNotification, <span class="keyword">sizeof</span>(cdcNotification));</div><div class="line">   epCdcNotification.getBuffer()[<span class="keyword">sizeof</span>(cdcNotification)+0] = status;</div><div class="line">   epCdcNotification.getBuffer()[<span class="keyword">sizeof</span>(cdcNotification)+1] = 0;</div><div class="line"></div><div class="line">   <span class="comment">// Set up to Tx packet</span></div><div class="line"><span class="comment">//   console.write(&quot;epCdcSendNotification() 0x&quot;).writeln(epCdcNotification.getBuffer()[sizeof(cdcNotification)+0], USBDM::Radix_16);</span></div><div class="line">   epCdcNotification.startTxStage(<a name="a37"></a><a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, <span class="keyword">sizeof</span>(cdcNotification)+2);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t cdcOutBuff[10] = <span class="stringliteral">&quot;Welcome\n&quot;</span>;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> cdcOutByteCount    = 8;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Start CDC IN transaction\n</span></div><div class="line"><span class="comment"> * A packet is only sent if data is available</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::startCdcIn() {</div><div class="line">   <span class="keywordflow">if</span> ((epCdcDataIn.getState() == <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) &amp;&amp; (cdcOutByteCount&gt;0)) {</div><div class="line">      static_assert(epCdcDataIn.BUFFER_SIZE&gt;<span class="keyword">sizeof</span>(cdcOutBuff), <span class="stringliteral">&quot;Buffer too small&quot;</span>);</div><div class="line">      <a class="code" href="class_u_s_b_d_m_1_1_endpoint.html#a298ef32b4fc2f62d5ad0d911a507a944">Endpoint::safeCopy</a>(epCdcDataIn.getBuffer(), cdcOutBuff, cdcOutByteCount);</div><div class="line">      <span class="comment">//TODO Check if need ZLP</span></div><div class="line">      epCdcDataIn.setNeedZLP();</div><div class="line">      epCdcDataIn.startTxStage(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, cdcOutByteCount);</div><div class="line">      cdcOutByteCount = 0;</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handler for Token Complete USB interrupts for</span></div><div class="line"><span class="comment"> * end-points other than EP0</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param usbStat USB Status value from USB hardware</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleTokenComplete(<a name="_a38"></a><a class="code" href="union_usb_stat.html">UsbStat</a> usbStat) {</div><div class="line"></div><div class="line">   <span class="comment">// Endpoint number</span></div><div class="line">   uint8_t endPoint = usbStat.<a name="a39"></a><a class="code" href="union_usb_stat.html#a24a2f02cc8e5d72ce45ba5c1825e52c1">endp</a>;</div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span> (endPoint) {</div><div class="line">      <span class="keywordflow">case</span> BULK_OUT_ENDPOINT: <span class="comment">// Accept OUT token</span></div><div class="line">         epBulkOut.handleOutToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> BULK_IN_ENDPOINT: <span class="comment">// Accept IN token</span></div><div class="line">         epBulkIn.handleInToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> CDC_NOTIFICATION_ENDPOINT: <span class="comment">// Accept IN token</span></div><div class="line">         <span class="comment">// CDC Notification has been ACKed</span></div><div class="line"><span class="comment">//         console.WRITELN(&quot;CDC_NOTIFICATION_ENDPOINT&quot;);</span></div><div class="line">         epCdcNotification.handleInToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> CDC_DATA_OUT_ENDPOINT: <span class="comment">// Accept OUT token</span></div><div class="line"><span class="comment">//         console.WRITELN(&quot;CDC_DATA_OUT_ENDPOINT&quot;);</span></div><div class="line">         epCdcDataOut.handleOutToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="keywordflow">case</span> CDC_DATA_IN_ENDPOINT:  <span class="comment">// Accept IN token</span></div><div class="line"><span class="comment">//         console.WRITELN(&quot;CDC_DATA_IN_ENDPOINT&quot;);</span></div><div class="line">         <span class="comment">// Data has been ACKed</span></div><div class="line">         epCdcDataIn.handleInToken();</div><div class="line">         <span class="keywordflow">return</span>;</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional end-point handling here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling CDC-OUT transaction complete\n</span></div><div class="line"><span class="comment"> * Data received is passed to the cdcInterface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] state Current end-point state (always EPDataOut)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return The endpoint state to set after call-back (EPDataOut)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a name="a40"></a><a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> Usb0::cdcOutTransactionCallback(<a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   <span class="comment">//   console.WRITELN(&quot;cdc_out&quot;);</span></div><div class="line">   <a name="a41"></a><a class="code" href="error_8h.html#ad85546c3822965abd94bc5e72243f313">usbdm_assert</a>(state == <a name="a42"></a><a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, <span class="stringliteral">&quot;Incorrect endpoint state&quot;</span>);</div><div class="line">   cdcInterface::putData(epCdcDataOut.getDataTransferredSize(), epCdcDataOut.getBuffer());</div><div class="line">   <span class="comment">// Set up for next transfer</span></div><div class="line">   epCdcDataOut.startRxStage(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, epCdcDataOut.BUFFER_SIZE);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling CDC-IN transaction complete\n</span></div><div class="line"><span class="comment"> * Checks for data and schedules transfer as necessary\n</span></div><div class="line"><span class="comment"> * Each transfer will have a ZLP as necessary.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] state Current end-point state (always EPDataIn)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return The endpoint state to set after call-back (EPIdle/EPDataIn)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> Usb0::cdcInTransactionCallback(<a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   <a class="code" href="error_8h.html#ad85546c3822965abd94bc5e72243f313">usbdm_assert</a>(state == <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, <span class="stringliteral">&quot;Incorrect endpoint state&quot;</span>);</div><div class="line">   <span class="keyword">static</span> uint8_t buffer[20];</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (state == <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>) {</div><div class="line">      <span class="keywordtype">int</span> size = cdcInterface::getData(<span class="keyword">sizeof</span>(buffer), buffer);</div><div class="line">      <span class="keywordflow">if</span> (size != 0) {</div><div class="line">         <span class="comment">// Schedules transfer</span></div><div class="line">         epCdcDataIn.setNeedZLP();</div><div class="line">         epCdcDataIn.startTxTransaction(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, size, buffer);</div><div class="line">      }</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Notify IN (device-&gt;host) endpoint that data is available</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return Not used</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">bool</span> Usb0::notify() {</div><div class="line">   <span class="keywordflow">if</span> (epCdcDataIn.getState() == <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <span class="comment">// Restart IN transactions</span></div><div class="line">      cdcInTransactionCallback(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>);</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling BULK-OUT transaction complete</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] state Current end-point state</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return The endpoint state to set after call-back (EPIdle)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> Usb0::bulkOutTransactionCallback(<a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   (void)state;</div><div class="line">   <span class="comment">// No actions - End-point is polled</span></div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Call-back handling BULK-IN transaction complete</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] state Current end-point state</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return The endpoint state to set after call-back (EPIdle)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> Usb0::bulkInTransactionCallback(<a class="code" href="group___u_s_b___group.html#ga124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state) {</div><div class="line">   (void)state;</div><div class="line">   <span class="comment">// No actions - End-point is polled</span></div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Initialise the USB0 interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  @note Assumes clock set up for USB operation (48MHz)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::initialise() {</div><div class="line">   <a name="a43"></a><a class="code" href="group___u_s_b___group.html#ga15053b03de92469cdc929b52415a761a">UsbBase_T::initialise</a>();</div><div class="line"></div><div class="line">   <span class="comment">// Add extra handling of CDC packets directed to EP0</span></div><div class="line">   setUnhandledSetupCallback(handleUserEp0SetupRequests);</div><div class="line"></div><div class="line">   setSOFCallback(sofCallback);</div><div class="line"></div><div class="line">   cdcInterface::initialise();</div><div class="line">   cdcInterface::setUsbInNotifyCallback(notify);</div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * TODO Additional initialisation</span></div><div class="line"><span class="comment">    */</span></div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Blocking reception of data over bulk OUT end-point</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @param[in] maxSize  Maximum # of bytes to receive</span></div><div class="line"><span class="comment"> *   @param[in] buffer   Pointer to buffer for bytes received</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @return Number of bytes received</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @note Doesn&#39;t return until command has been received.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> Usb0::receiveBulkData(uint8_t maxSize, uint8_t *buffer) {</div><div class="line">   epBulkOut.startRxStage(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, maxSize, buffer);</div><div class="line">   <span class="keywordflow">while</span>(epBulkOut.getState() != <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <span class="keywordflow">if</span> (!areInterruptsEnabled()) {</div><div class="line">         ::enableInterrupts();</div><div class="line">      }</div><div class="line">      <a name="a44"></a><a class="code" href="group___c_m_s_i_s___core___instruction_interface.html#ga8a55dfb43484b3ed4d181761f92cc2db">__WFI</a>();</div><div class="line">   }</div><div class="line">   setActive();</div><div class="line">   <span class="keywordflow">return</span> epBulkOut.getDataTransferredSize();</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  Blocking transmission of data over bulk IN end-point</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  @param[in] size   Number of bytes to send</span></div><div class="line"><span class="comment"> *  @param[in] buffer Pointer to bytes to send</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   @note : Waits for idle BEFORE transmission but\n</span></div><div class="line"><span class="comment"> *   returns before data has been transmitted</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::sendBulkData(uint8_t size, <span class="keyword">const</span> uint8_t *buffer) {</div><div class="line"><span class="comment">//   commandBusyFlag = false;</span></div><div class="line">   <span class="comment">//   enableUSBIrq();</span></div><div class="line">   <span class="keywordflow">while</span> (epBulkIn.getState() != <a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdafa90f9e0eb7ee888a8d2d32383523255">EPIdle</a>) {</div><div class="line">      <a class="code" href="group___c_m_s_i_s___core___instruction_interface.html#ga8a55dfb43484b3ed4d181761f92cc2db">__WFI</a>();</div><div class="line">   }</div><div class="line">   epBulkIn.startTxStage(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacdad7d2d462ab230f223603c1aeebb1c2f8">EPDataIn</a>, size, buffer);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Set line coding handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSetLineCoding() {</div><div class="line"><span class="comment">//   console.WRITELN(&quot;handleSetLineCoding()&quot;);</span></div><div class="line">   <span class="keyword">static</span> <a name="_a45"></a><a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a> lineCoding;</div><div class="line"></div><div class="line">   <span class="comment">// Call-back to do after transaction complete</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">auto</span> callback = []() {</div><div class="line">      <span class="comment">// The controlEndpoint buffer will contain the LineCodingStructure data at call-back time</span></div><div class="line">      cdcInterface::setLineCoding(&amp;lineCoding);</div><div class="line">      setSetupCompleteCallback(<span class="keyword">nullptr</span>);</div><div class="line">   };</div><div class="line">   setSetupCompleteCallback(callback);</div><div class="line"></div><div class="line">   <span class="comment">// Don&#39;t use external buffer - this requires response to fit in internal EP buffer</span></div><div class="line">   static_assert(<span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>) &lt; fControlEndpoint.BUFFER_SIZE, <span class="stringliteral">&quot;Buffer insufficient size&quot;</span>);</div><div class="line">   fControlEndpoint.startRxStage(<a class="code" href="group___u_s_b___group.html#gga124f63fb6f98bc31674386e28e12dacda0f056f12ece9450fe381e8ea569e2581">EPDataOut</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>), (uint8_t*)&amp;lineCoding);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Get line coding handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleGetLineCoding() {</div><div class="line"><span class="comment">//   console.WRITELN(&quot;handleGetLineCoding()&quot;);</span></div><div class="line">   <span class="comment">// Send packet</span></div><div class="line">   ep0StartTxStage( <span class="keyword">sizeof</span>(<a class="code" href="struct_line_coding_structure.html">LineCodingStructure</a>), (<span class="keyword">const</span> uint8_t*)cdcInterface::getLineCoding());</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Set line state handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSetControlLineState() {</div><div class="line"><span class="comment">//   console.write(&quot;handleSetControlLineState() &quot;).writeln(fEp0SetupBuffer.wValue.lo(), USBDM::Radix_16);</span></div><div class="line">   cdcInterface::setControlLineState(fEp0SetupBuffer.wValue.lo());</div><div class="line">   <span class="comment">// Tx empty Status packet</span></div><div class="line">   ep0StartTxStage( 0, <span class="keyword">nullptr</span> );</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CDC Send break handler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> Usb0::handleSendBreak() {</div><div class="line"><span class="comment">//   console.WRITELN(&quot;handleSendBreak()&quot;);</span></div><div class="line">   cdcInterface::sendBreak(fEp0SetupBuffer.wValue);</div><div class="line">   <span class="comment">// Tx empty Status packet</span></div><div class="line">   ep0StartTxStage( 0, <span class="keyword">nullptr</span> );</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Handle SETUP requests not handled by base handler</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param[in] setup SETUP packet received from host</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @note Provides CDC extensions</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26">ErrorCode</a> Usb0::handleUserEp0SetupRequests(<span class="keyword">const</span> <a name="_a46"></a><a class="code" href="struct_setup_packet.html">SetupPacket</a> &amp;setup) {</div><div class="line">   <span class="comment">//console.WRITELN(&quot;handleUserEp0SetupRequests()&quot;);</span></div><div class="line">   <span class="keywordflow">switch</span>(<a name="a47"></a><a class="code" href="group___u_s_b___group.html#ga63b7629b307c8b24b0c0bafa27c664ff">REQ_TYPE</a>(setup.<a name="a48"></a><a class="code" href="struct_setup_packet.html#a5cdaae68cef911cbf007d99765049eac">bmRequestType</a>)) {</div><div class="line">      <span class="keywordflow">case</span> <a name="a49"></a><a class="code" href="group___u_s_b___group.html#ggad1d869fc04b4f3956b307f344ae3f2e8a91b25654fbdfaec6e82fe5c621971d7f">UsbRequestType_CLASS</a> :</div><div class="line">         <span class="comment">// Class requests</span></div><div class="line">         <span class="keywordflow">switch</span> (setup.<a name="a50"></a><a class="code" href="struct_setup_packet.html#a358b4fadfa04e79e9747161891e45363">bRequest</a>) {</div><div class="line">            <span class="keywordflow">case</span> <a name="a51"></a><a class="code" href="group___u_s_b___group.html#ggae0ce006ca194dd988fe484dac60ae958a2c11c68281de60dcdd56dd5bf9d9812f">SET_LINE_CODING</a> :       handleSetLineCoding();       <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a52"></a><a class="code" href="group___u_s_b___group.html#ggae0ce006ca194dd988fe484dac60ae958a27e4eab85d3fdd726ae23ed04c3898f2">GET_LINE_CODING</a> :       handleGetLineCoding();       <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a53"></a><a class="code" href="group___u_s_b___group.html#ggae0ce006ca194dd988fe484dac60ae958aa88ebf08d70350c908d9aa766ae7ca44">SET_CONTROL_LINE_STATE</a>: handleSetControlLineState(); <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <a name="a54"></a><a class="code" href="group___u_s_b___group.html#ggae0ce006ca194dd988fe484dac60ae958aec112b5b07fd11ab2dee0ddd274bd47b">SEND_BREAK</a>:             handleSendBreak();           <span class="keywordflow">break</span>;</div><div class="line">            default :                    fControlEndpoint.stall();    <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">         fControlEndpoint.stall();</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b_d_m.html#af5406ca776612b2687e916fb194ffd26a4ba45ce064022eb4eb90e52c3d48a83a">E_NO_ERROR</a>;</div><div class="line">}</div><div class="line"></div><div class="line">} <span class="comment">// End namespace USBDM</span></div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Oct 31 2019 16:45:44 for Lab5_Section2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
